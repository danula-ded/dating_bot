# **–û–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ Dating Bot**

## üèó **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Telegram-–±–æ—Ç–∞**

### üì± **–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å**

- **Telegram Client** - –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- **Polling/Webhook** - –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram.

### üñ• **–°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å (Producer)**

- **–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä**:
  - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –æ—Ç Telegram.
  - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
  - –§–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã.

### üóÑ **–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**

- **PostgreSQL** - –æ—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö.
- **Minio (S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–¥–∏–∞ (—Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ).
- **Redis**:
  - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
  - –•—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Å–µ—Å—Å–∏–∏, —Å–æ—Å—Ç–æ—è–Ω–∏—è).

### üîÑ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (Consumer)**

- **RabbitMQ** - –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è:
  - –î–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  - –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–æ–Ω—Å—é–º–µ—Ä–æ–º
  - –î–ª—è –±–µ–∑–ø–µ—Ä–µ–±–æ–π–Ω–æ–π —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
- **Consumer-—Å–µ—Ä–≤–µ—Ä** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á –∏–∑ –æ—á–µ—Ä–µ–¥–∏.

### üîî **–û–±—Ä–∞–±–æ—Ç–∫–∞ –§–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á—å (Celery)**

### üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**

- **Prometheus** - —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫:
  - –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  - –û—à–∏–±–∫–∏
  - –ù–∞–≥—Ä—É–∑–∫–∞

![–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤ –ø–∞–ø–∫–µ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞](./Arhitecthure.jpg)

### **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

1. **Frontend** ‚Üí Telegram Bot (`aiogram`).
2. **Backend Services** ‚Üí FastAPI (RESTful API).
3. **Database** ‚Üí PostgreSQL (–æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) + Redis (–∫—ç—à).
4. **Storage** ‚Üí MinIO (S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Ñ–æ—Ç–æ).
5. **Message Broker** ‚Üí RabbitMQ (–¥–ª—è —Å–æ–±—ã—Ç–∏–π: –ª–∞–π–∫–∏, –ø—Ä–æ–ø—É—Å–∫–∏, –º—ç—Ç—á–∏).
6. **Celery** ‚Üí –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (–ø–µ—Ä–µ—Å—á–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥–∞, –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞).

---

![–°—Ö–µ–º–∞ –î–∞–Ω–Ω—ã—Ö –≤ UML](./schemas.png)

---

## PostgreSQL –¢–∞–±–ª–∏—Ü—ã —Å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü

```sql
-- –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≥–æ—Ä–æ–¥–æ–≤
CREATE TABLE cities (
    city_id SERIAL PRIMARY KEY,
    name VARCHAR(64) NOT NULL UNIQUE
);

-- –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE users (
    user_id BIGINT PRIMARY KEY,
    username VARCHAR(64) UNIQUE,
    first_name VARCHAR(64) NOT NULL,
    age INTEGER CHECK (age >= 18),
    gender VARCHAR(10) CHECK (gender IN ('male', 'female', 'other')),
    city_id INTEGER REFERENCES cities(city_id),
    created_at TIMESTAMP DEFAULT NOW()
);

-- –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
CREATE TABLE interests (
    interest_id SERIAL PRIMARY KEY,
    name VARCHAR(64) NOT NULL UNIQUE
);

-- –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å–≤—è–∑–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
CREATE TABLE user_interests (
    user_id BIGINT REFERENCES users(user_id) ON DELETE CASCADE,
    interest_id INTEGER REFERENCES interests(interest_id) ON DELETE CASCADE,
    PRIMARY KEY (user_id, interest_id)
);

-- –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–æ—Ñ–∏–ª–µ–π
CREATE TABLE profiles (
    profile_id SERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(user_id) ON DELETE CASCADE UNIQUE,
    bio TEXT,
    photo_url TEXT,
    preferred_gender VARCHAR(10) CHECK (preferred_gender IN ('male', 'female', 'other')),
    preferred_age_min INTEGER CHECK (preferred_age_min >= 18),
    preferred_age_max INTEGER CHECK (preferred_age_max >= preferred_age_min)
);

-- –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
CREATE TABLE ratings (
    rating_id SERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(user_id) ON DELETE CASCADE UNIQUE,
    profile_score FLOAT DEFAULT 0 CHECK (profile_score BETWEEN 0 AND 10),
    activity_score FLOAT DEFAULT 0 CHECK (activity_score BETWEEN 0 AND 10)
);
```

### –í—Å—Ç–∞–≤–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```sql
-- –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–æ–¥–∞
INSERT INTO cities (name) VALUES
('–ú–æ—Å–∫–≤–∞'),
('–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥'),
('–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫'),
('–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥'),
('–ö–∞–∑–∞–Ω—å');

-- –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä–µ—Å—ã
INSERT INTO interests (name) VALUES
('–ú—É–∑—ã–∫–∞'),
('–°–ø–æ—Ä—Ç'),
('–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è'),
('–ö–∏–Ω–æ'),
('–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ'),
('–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è'),
('–ö—É–ª–∏–Ω–∞—Ä–∏—è');

-- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
INSERT INTO users (user_id, username, first_name, last_name, age, gender, city_id) VALUES
(1001, 'ivan_petrov', '–ò–≤–∞–Ω', '–ü–µ—Ç—Ä–æ–≤', 25, 'male', 1),
(1002, 'anna_smirnova', '–ê–Ω–Ω–∞', '–°–º–∏—Ä–Ω–æ–≤–∞', 22, 'female', 2),
(1003, 'alex_volkov', '–ê–ª–µ–∫—Å–µ–π', '–í–æ–ª–∫–æ–≤', 30, 'male', 1),
(1004, 'elena_kuz', '–ï–ª–µ–Ω–∞', '–ö—É–∑–Ω–µ—Ü–æ–≤–∞', 28, 'female', 3),
(1005, 'max_ivanov', '–ú–∞–∫—Å–∏–º', '–ò–≤–∞–Ω–æ–≤', 19, 'male', 4);

-- –î–æ–±–∞–≤–ª—è–µ–º —Å–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏
INSERT INTO user_interests (user_id, interest_id) VALUES
(1001, 1), (1001, 3), (1001, 5),  -- –ò–≤–∞–Ω: –º—É–∑—ã–∫–∞, –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ
(1002, 2), (1002, 4), (1002, 7),  -- –ê–Ω–Ω–∞: —Å–ø–æ—Ä—Ç, –∫–∏–Ω–æ, –∫—É–ª–∏–Ω–∞—Ä–∏—è
(1003, 1), (1003, 2), (1003, 6),  -- –ê–ª–µ–∫—Å–µ–π: –º—É–∑—ã–∫–∞, —Å–ø–æ—Ä—Ç, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è
(1004, 3), (1004, 5), (1004, 7),  -- –ï–ª–µ–Ω–∞: –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –∫—É–ª–∏–Ω–∞—Ä–∏—è
(1005, 2), (1005, 4), (1005, 6);  -- –ú–∞–∫—Å–∏–º: —Å–ø–æ—Ä—Ç, –∫–∏–Ω–æ, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è

-- –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª–∏
INSERT INTO profiles (user_id, bio, photo_url, preferred_gender, preferred_age_min, preferred_age_max) VALUES
(1001, '–õ—é–±–ª—é –ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞—Ç—å', 'https://storage.example.com/1001.jpg', 'female', 20, 30),
(1002, '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∑–∞–Ω–∏–º–∞—é—Å—å —Ç–µ–Ω–Ω–∏—Å–æ–º', 'https://storage.example.com/1002.jpg', 'male', 22, 35),
(1003, '–§–æ—Ç–æ–≥—Ä–∞—Ñ –∏ –º—É–∑—ã–∫–∞–Ω—Ç', 'https://storage.example.com/1003.jpg', 'female', 25, 40),
(1004, '–†–∞–±–æ—Ç–∞—é –≤ IT, –º–µ—á—Ç–∞—é –æ–±—ä–µ–∑–¥–∏—Ç—å –≤–µ—Å—å –º–∏—Ä', 'https://storage.example.com/1004.jpg', 'male', 25, 35),
(1005, '–°—Ç—É–¥–µ–Ω—Ç, —É–≤–ª–µ–∫–∞—é—Å—å —Å–ø–æ—Ä—Ç–æ–º', 'https://storage.example.com/1005.jpg', 'female', 18, 25);

-- –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥–∏
INSERT INTO ratings (user_id, profile_score, activity_score) VALUES
(1001, 8.5, 7.2),
(1002, 9.1, 8.7),
(1003, 7.8, 6.5),
(1004, 8.9, 7.8),
(1005, 6.5, 5.3);
```

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

1. **–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ú–æ—Å–∫–≤—ã:**

```sql
SELECT u.user_id, u.first_name, u.last_name, c.name as city
FROM users u
JOIN cities c ON u.city_id = c.city_id
WHERE c.name = '–ú–æ—Å–∫–≤–∞';
```

2. **–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏–Ω—Ç–µ—Ä–µ—Å–æ–º "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è":**

```sql
SELECT u.user_id, u.first_name, u.last_name
FROM users u
JOIN user_interests ui ON u.user_id = ui.user_id
JOIN interests i ON ui.interest_id = i.interest_id
WHERE i.name = '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è';
```

3. **–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (–≤–∫–ª—é—á–∞—è –ø—Ä–æ—Ñ–∏–ª—å –∏ —Ä–µ–π—Ç–∏–Ω–≥):**

```sql
SELECT
    u.user_id,
    u.first_name,
    u.age,
    c.name as city,
    p.bio,
    p.photo_url,
    r.profile_score,
    r.activity_score
FROM users u
JOIN cities c ON u.city_id = c.city_id
JOIN profiles p ON u.user_id = p.user_id
JOIN ratings r ON u.user_id = r.user_id
WHERE u.user_id = 1001;
```

4. **–ù–∞–π—Ç–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –ø–∞—Ä—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**

```sql
-- –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID 1001 (–ò–≤–∞–Ω)
SELECT
    u.user_id,
    u.first_name,
    u.age,
    p.bio,
    r.profile_score + r.activity_score as total_score
FROM users u
JOIN profiles p ON u.user_id = p.user_id
JOIN ratings r ON u.user_id = r.user_id
WHERE
    u.gender = (SELECT preferred_gender FROM profiles WHERE user_id = 1001)
    AND u.age BETWEEN (SELECT preferred_age_min FROM profiles WHERE user_id = 1001)
                  AND (SELECT preferred_age_max FROM profiles WHERE user_id = 1001)
    AND u.user_id != 1001
ORDER BY total_score DESC;
```
